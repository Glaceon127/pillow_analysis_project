"""漏洞模式分析模块。

输入：
- CVE 列表（建议使用 pillow_cves_with_commits.json）
- 可选：commit 索引（hash -> commit dict），用于推导修复提交时间

输出：用于可视化/报告的统计信息（纯 dict，可 JSON 化）。
"""

from __future__ import annotations

from collections import Counter
from typing import Any, Dict, List, Optional

import pandas as pd


class VulnerabilityAnalyzer:
    def analyze(self, cves: List[Dict[str, Any]], commit_index: Optional[Dict[str, Dict[str, Any]]] = None) -> Dict[str, Any]:
        cves = cves or []
        commit_index = commit_index or {}

        if not cves:
            return {
                'total_cves': 0,
                'with_cve_id': 0,
                'matched_cves': 0,
                'match_types_top': [],
                'cves_by_month': [],
                'matched_by_month': [],
                'fix_commit_date_stats': {
                    'with_fix_commit_date': 0,
                    'min': None,
                    'max': None,
                },
            }

        df = pd.DataFrame(cves)

        # ========== 核心修复：正确处理id列 ==========
        if 'id' in df.columns:
            df['id'] = df['id'].fillna('')
        else:
            df['id'] = ''  # 列不存在时创建空列

        # 兼容我们生成的cve_id字段（如果有）
        if 'cve_id' in df.columns and (df['id'].isna().all() or df['id'].eq('').all()):
            df['id'] = df['cve_id'].fillna('')

        # ========== 合理处理match_types ==========
        # 如果原始数据有match_types字段，直接用；否则主动匹配
        if 'match_types' not in df.columns:
            df = self._active_match_cves_to_commits(df, commit_index)
        # 修复matched列的处理逻辑
        if 'matched' in df.columns:
            df['matched'] = df['matched'].fillna(False).astype(bool)
        else:
            # 如果有matched_commits字段，自动推断
            if 'matched_commits' in df.columns:
                df['matched'] = df['matched_commits'].apply(lambda x: bool(x and isinstance(x, list) and len(x) > 0))
            else:
                df['matched'] = False

        # published timeline
        if 'published' in df.columns:
            df['published_dt'] = pd.to_datetime(df['published'], errors='coerce', utc=True)
        elif 'published_date' in df.columns:
            df['published_dt'] = pd.to_datetime(df['published_date'], errors='coerce', utc=True)
        else:
            df['published_dt'] = pd.NaT

        total_cves = int(len(df))
        with_cve_id = int((df['id'].astype(str).str.startswith('CVE-')).sum())
        matched_cves = int(df['matched'].sum())

        # match types distribution
        mt_counter: Counter[str] = Counter()
        for mts in df['match_types']:
            if isinstance(mts, list):
                mt_counter.update([m for m in mts if isinstance(m, str) and m])
            elif isinstance(mts, str) and mts:
                mt_counter.update([x for x in mts.split('|') if x])
        # 显示所有类型，不限制数量
        match_types_all = [{'type': t, 'count': int(n)} for t, n in mt_counter.items()]

        # cves by month
        cves_by_month = []
        matched_by_month = []
        if df['published_dt'].notna().any():
            g = df.dropna(subset=['published_dt']).copy()
            g['month'] = g['published_dt'].dt.to_period('M').astype(str)
            bym = g.groupby('month').size().reset_index(name='count').sort_values('month')
            cves_by_month = bym.to_dict(orient='records')

            gbm = g[g['matched']].groupby('month').size().reset_index(name='count').sort_values('month')
            matched_by_month = gbm.to_dict(orient='records')

        # infer fix commit date if possible
        fix_dates: List[pd.Timestamp] = []
        for _, item in df.iterrows():
            if not item.get('matched'):
                continue
            hashes = item.get('matched_commits') or []
            if not isinstance(hashes, list):
                continue
            for h in hashes:
                cm = commit_index.get(h)
                if not cm:
                    continue
                dt = pd.to_datetime(cm.get('date'), errors='coerce', utc=True)
                if pd.notna(dt):
                    fix_dates.append(dt)

        fix_commit_date_stats = {
            'with_fix_commit_date': int(len(fix_dates)),
            'min': min(fix_dates).isoformat() if fix_dates else None,
            'max': max(fix_dates).isoformat() if fix_dates else None,
        }

        return {
            'total_cves': total_cves,
            'with_cve_id': with_cve_id,
            'matched_cves': matched_cves,
            'match_types_all': match_types_all,  # 修改为全部类型
            'cves_by_month': cves_by_month,
            'matched_by_month': matched_by_month,
            'fix_commit_date_stats': fix_commit_date_stats,
        }

    def _active_match_cves_to_commits(self, df: pd.DataFrame, commit_index: Dict[str, Dict[str, Any]]) -> pd.DataFrame:
        """
        主动匹配CVE与提交（核心新增方法）
        :param df: CVE数据的DataFrame
        :param commit_index: 提交哈希到提交详情的映射
        :return: 填充了matched和matched_commits字段的DataFrame
        """
        if not commit_index:
            return df

        # 预处理：提取所有提交的信息，生成"提交哈希-提交内容"的映射
        commit_content_map = {}
        for commit_hash, commit in commit_index.items():
            # 合并提交信息和修改文件，作为匹配的内容
            commit_msg = commit.get('message', '').lower()
            commit_files = ' '.join(commit.get('files', [])).lower()
            commit_content = f"{commit_msg} {commit_files}"
            commit_content_map[commit_hash] = commit_content

        # 遍历每个CVE，进行关键词匹配
        matched_commits_list = []
        matched_flags = []
        match_types_list = []

        for _, row in df.iterrows():
            cve_id = row.get('id', '').strip()
            cve_desc = row.get('description', '').strip().lower()
            matched_commits = []
            match_type = []

            # 提取CVE的核心关键词
            cve_keywords = set()
            # 1. CVE编号关键词（如 CVE-2023-1234、2023-1234）
            if cve_id.startswith('CVE-'):
                cve_keywords.add(cve_id.lower())
                cve_keywords.add(cve_id.replace('CVE-', '').lower())
            # 2. 描述中的核心关键词（过滤停用词）
            stop_words = {'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'is', 'are'}
            desc_words = [word.strip('.,;:()[]{}!?') for word in cve_desc.split() if word.strip() not in stop_words]
            cve_keywords.update(desc_words[:15])  # 取前15个核心词
            # 3. 项目相关关键词（确保匹配Pillow提交）
            cve_keywords.update(['pillow', 'pil', 'image', 'vulnerability', 'fix', 'bug', 'security', 'patch'])

            # 遍历所有提交，匹配关键词
            for commit_hash, commit_content in commit_content_map.items():
                if any(keyword in commit_content for keyword in cve_keywords):
                    matched_commits.append(commit_hash)

            # 标记是否匹配成功
            if matched_commits:
                matched_flags.append(True)
                matched_commits_list.append(matched_commits)
                match_types_list.append(['keyword_match'])
            else:
                matched_flags.append(False)
                matched_commits_list.append([])
                match_types_list.append([])

        # 将匹配结果填充到DataFrame
        df['matched'] = matched_flags
        df['matched_commits'] = matched_commits_list
        df['match_types'] = match_types_list

        return df